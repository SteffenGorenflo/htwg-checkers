<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTWG-Checkers</title>

    <link href="css/style.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

</head>
<body>

<div id="title" class="center"></div>

<div class="center field-container">
    <div id="0" class="row">
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
    </div>
    <div id="1" class="row">
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
    </div>
    <div id="2" class="row">
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
    </div>
    <div id="3" class="row">
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
    </div>
    <div id="4" class="row">
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
    </div>
    <div id="5" class="row">
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
    </div>
    <div id="6" class="row">
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
    </div>
    <div id="7" class="row">
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
        <div class="field even"></div>
        <div class="field uneven"></div>
    </div>
</div>

<script>
    var wsUri = "ws://localhost:9000/socket";
    var output;

    // playfield infos
    var playfield = [];
    var currentplayer;
    var possibleTargets = [];
    var possibleMoves;
    var possibleOrigins = [];
    var selected;

    // images
    const black = '<img src="images/BLACK.png">';
    const white = '<img src="images/WHITE.png">';


    var websocket;

    // websocket messages
    // queries
    //    websocket.send(JSON.stringify({query: "getcurrentplayer"}));
    //    websocket.send(JSON.stringify({query: "gamestatus"}));
    //
    //    websocket.send(JSON.stringify({query: "getmoves"}));
    //    websocket.send(JSON.stringify({query: "getpossibletargets", x: 1, y: 1}));
    //
    //    // execute
    //    websocket.send(JSON.stringify({execute: "quitgame"}));
    //    websocket.send(JSON.stringify({execute: "newgame"}));
    //    websocket.send(JSON.stringify({execute: "setpiece", x1: 1, y1: 1, x2: 2, y2: 2}));


    $(document).ready(function () {

        // init websocket
        websocket = new WebSocket(wsUri);
        websocket.onopen = socketFunction.onOpen;
        websocket.onclose = socketFunction.onClose;
        websocket.onmessage = socketFunction.onMessage;
        websocket.onerror = socketFunction.onError;
    });

    var mainFunction = function () {

        $('.field').on('click', function (e) {

            // first get the coordinates
            var field = $(this).css("background-color", "#88c400");
            var x = field.parent().attr('id');
            var y = field.index();
            var query = {query: "getpossibletargets"};
            query.x = parseInt(x);
            query.y = y;
            console.log(query);
            websocket.send(JSON.stringify(query));
            if (!selected) {

            }
            console.log(e);

            console.log()
        });

        $('.field').mouseenter(function () {
            var elem = $(this);
            var index = checkersIndex(elem);
            if (contains(index, possibleOrigins)) {
                elem.addClass('highlight')
            }
        }).mouseleave(function () {
            $(this).removeClass('highlight')
        });
    };


    function update() {
        playfield.forEach(function (field) {
            $(jQueryIndex(field.pos.x, field.pos.y))
                .append(field.piece.colour === 'Black' ? black : white);
        });
        websocket.send(JSON.stringify({query: "getpossiblepieces"}));
    }

    var displayPossibleTargets = function () {
        possibleTargets.forEach(function (target) {
            $(jQueryIndex(target.x, target.y))
                .css("background-color", "#88c400");
        })
    };

    var socketFunction = {
        onOpen: mainFunction,
        onError: function (event) {
            console.error('Websocket Error', event);
        },
        onClose: function (event) {
            console.log('Websockets closed', event)
        },
        onMessage: function (event) {
            var data = JSON.parse(event.data);

            if (data.moves) {
                possibleMoves = data.moves;
            } else if (data.vector) {
                playfield = data.vector;
                update();
            } else if (data.origins) {
                console.log('Got origins', data);
                possibleOrigins = data.origins;
                markOrigins();
            } else if (data.targets) {
                console.log('Got Targets', data);
                possibleTargets = data.targets;
            } else if (data === 'Black' || data === 'White') {
                currentplayer = data;
            } else {
                console.log("Got unkown message", data);
            }
        }
    };

    var jQueryIndex = function (x, y) {
        return '#' + x + ' div:nth-child(' + (y + 1) + ')'
    };

    var markOrigins = function () {
        possibleOrigins.forEach(function (field) {
            $(jQueryIndex(field.x, field.y)).addClass('hovered')
        });
    };

    var checkersIndex = function (elem) {
        var reval = {};
        reval.x = parseInt(elem.parent().attr('id'));
        reval.y = elem.index();
        return reval;
    };

    var contains = function (field, listOfFields) {
        return listOfFields.some(function (elem) {
            return (elem.x === field.x && elem.y === field.y);
        })
    }

</script>
</body>
</html>